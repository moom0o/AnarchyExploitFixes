package me.moomoo.anarchyexploitfixes;

import me.moomoo.anarchyexploitfixes.misc.Chat;
import me.moomoo.anarchyexploitfixes.misc.Commands;
import me.moomoo.anarchyexploitfixes.misc.Expansions;
import me.moomoo.anarchyexploitfixes.misc.Kicks;
import me.moomoo.anarchyexploitfixes.patches.*;
import me.moomoo.anarchyexploitfixes.prevention.*;
import org.bstats.bukkit.Metrics;
import org.bukkit.Bukkit;
import org.bukkit.ChatColor;
import org.bukkit.Chunk;
import org.bukkit.Material;
import org.bukkit.configuration.file.FileConfiguration;
import org.bukkit.entity.Boat;
import org.bukkit.entity.Player;
import org.bukkit.event.Listener;
import org.bukkit.plugin.PluginManager;
import org.bukkit.plugin.java.JavaPlugin;

import java.util.HashMap;
import java.util.Map;
import java.util.logging.Logger;

public class Main extends JavaPlugin implements Listener {
    private static final int[] oldTotal = {0};
    private static final int[] newTotal = {0};
    public final Map<Player, Integer> newChunks = new HashMap<>();
    public final Map<Player, Integer> oldChunks = new HashMap<>();
    public Map<Player, Integer> a = new HashMap<>();
    public Map<Player, Integer> b = new HashMap<>();
    private Logger log;

    public static int[] getOldTotal() {
        return oldTotal;
    }

    public static int[] getNewTotal() {
        return newTotal;
    }

    @Override
    public void onEnable() {
        log = getLogger();
        PluginManager pm = getServer().getPluginManager();
        FileConfiguration config = getConfig();

        log.info(ChatColor.AQUA + "Loading config");
        saveDefaultConfig();

        log.info(ChatColor.AQUA + "Registering events");
        pm.registerEvents(new DupeFixes(this), this);
        pm.registerEvents(new DisableWithers(this), this);
        pm.registerEvents(new Elytra(this), this);
        pm.registerEvents(new EndPortalPatch(this), this);
        pm.registerEvents(new Bedrock(this), this);
        pm.registerEvents(new Boats(this), this);
        pm.registerEvents(new Chat(this), this);
        pm.registerEvents(new ChunkBan(this), this);
        pm.registerEvents(new Commands(this), this);
        pm.registerEvents(new CrashExploits(this), this);
        pm.registerEvents(new GodMode(this), this);
        pm.registerEvents(new Illegals(this), this);
        pm.registerEvents(new Joinmessages(this), this);
        pm.registerEvents(new Kicks(this), this);
        pm.registerEvents(new LagExploits(this), this);
        pm.registerEvents(new MyServer(this), this);
        pm.registerEvents(new NetherRoof(this), this);
        pm.registerEvents(new Redstone(this), this);

        log.info(ChatColor.AQUA + "Registering events finished");

        if (config.getBoolean("BoatflyPatchStrict")) {
            Bukkit.getServer().getScheduler().runTaskTimer(this, () -> Bukkit.getWorlds().forEach(b -> b.getPlayers().forEach(e -> {
                if (e.isInsideVehicle()) {
                    int x = e.getLocation().getBlockX();
                    int y = e.getLocation().getBlockY();
                    int z = e.getLocation().getBlockZ();
                    // ik its a mess idgaf
                    if ((e.getWorld().getBlockAt(x, y - 1, z).getType() == Material.AIR) && e.getWorld().getBlockAt(x, y - 2, z).getType() == Material.AIR && e.getWorld().getBlockAt(x, y - 3, z).getType() == Material.AIR) {
                        if (e.getVehicle() instanceof Boat) {
                            e.getVehicle().remove();
                            if (config.getBoolean("BoatflyMessage")) {
                                e.sendMessage(ChatColor.GOLD + "Boatfly disabled due to an exploit >:) If you aren't boat flying, boats on land are a little buggy.");
                            }
                        }
                    }
                }
            })), 0L, config.getInt("BoatflyPatchStrictCheckRate"));
        }

        if (config.getBoolean("StrictIllegalPrevention")) {
            Bukkit.getServer().getScheduler().runTaskTimer(this, () -> Bukkit.getWorlds().forEach(b -> b.getPlayers().forEach(e -> e.getInventory().forEach(bb -> {
                if (bb != null) {
                    if (bb.getAmount() > bb.getMaxStackSize()) {
                        bb.setAmount(bb.getMaxStackSize());
                    }
                }
            }))), 0L, 20L);
        }
        if (config.getBoolean("PreventGodMode")) {
            for (Player p : Bukkit.getOnlinePlayers()) {
                GodMode.removePlayer(p);
                GodMode.injectPlayer(p, this);
                a.put(p, 0);
                b.put(p, 0);
            }
        }
        Bukkit.getServer().getScheduler().runTaskTimer(this, () -> Bukkit.getWorlds().forEach(b -> b.getPlayers().forEach(e -> {
            if (newChunks.get(e) != null) {
                if (!e.isOp()) {
                    if (newChunks.get(e) > 60) {
                        broadcastOp(ChatColor.RED + e.getName() + " is generating a lot of chunks per second! (" + newChunks.get(e) + ")");
                    }
                }
            }
        })), 0L, 20L);

        Bukkit.getScheduler().runTaskTimer(this, () -> {
            newTotal[0] = 0;
            oldTotal[0] = 0;
            Bukkit.getOnlinePlayers().forEach(player -> {
                if (newChunks.get(player) != null) {
                    newTotal[0] = newTotal[0] + newChunks.get(player);
                }
            });
            Bukkit.getOnlinePlayers().forEach(player -> {
                if (oldChunks.get(player) != null) {
                    oldTotal[0] = oldTotal[0] + oldChunks.get(player);
                }
            });
        }, 0L, 20L);

        log.info(ChatColor.AQUA + "Looking for hooks");
        if (Bukkit.getPluginManager().getPlugin("PlaceholderAPI") != null)
            new Expansions(this).register();

        log.info(ChatColor.AQUA + "Loading metrics");
        new Metrics(this, 8700);

        log.info(ChatColor.AQUA + "[ENABLED] AnarchyExploitFixes - Made by moomoo");
    }

    @Override
    public void onDisable() {
        log.info("[DISABLED] AnarchyExploitFixes - Made by moomoo");
    }

    public Integer checkChunk(Material material, Chunk c) {
        int count = 0;
        int cx = c.getX() << 4;
        int cz = c.getZ() << 4;

        for (int x = cx; x < cx + 16; x++) {
            for (int z = cz; z < cz + 16; z++) {
                for (int y = 0; y < 128; y++) {
                    if (c.getBlock(x, y, z).getType() == material) {
                        count++;
                    }
                }
            }
        }

        return count;
    }

    void broadcastOp(String s) {
        Bukkit.getOnlinePlayers().forEach(b -> {
            if (b.isOp()) {
                b.sendMessage(s);
            }
        });

        log.info(s);
    }
}
