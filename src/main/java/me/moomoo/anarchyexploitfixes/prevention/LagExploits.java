package me.moomoo.anarchyexploitfixes.prevention;

import me.moomoo.anarchyexploitfixes.Main;
import org.bukkit.Bukkit;
import org.bukkit.Location;
import org.bukkit.configuration.file.FileConfiguration;
import org.bukkit.entity.EntityType;
import org.bukkit.entity.Player;
import org.bukkit.event.EventHandler;
import org.bukkit.event.Listener;
import org.bukkit.event.block.BlockPhysicsEvent;
import org.bukkit.event.entity.ProjectileLaunchEvent;

import java.awt.*;
import java.util.HashSet;

public class LagExploits implements Listener {
    private final Main plugin;
    HashSet<String> throwcooldown = new HashSet<>();
    HashSet<Location> throwcooldownlocations = new HashSet<>();

    public LagExploits(Main plugin) {
        this.plugin = plugin;
    }

    @EventHandler
    private void onEntityChange(BlockPhysicsEvent evt) {
        FileConfiguration config = plugin.getConfig();

        double tpsDouble = Bukkit.getServer().getTPS()[0];
        if (tpsDouble < config.getDouble("FallingBlocks")) {
            evt.setCancelled(true);
        }
    }

    @EventHandler
    private void onThrow(ProjectileLaunchEvent evt) {
        if (plugin.getConfig().getBoolean("PreventSnowBallExploit")) {
            boolean found = false;
            for (Player p : Bukkit.getOnlinePlayers()) {
                Point p1 = new Point(evt.getEntity().getLocation().getBlockX(), evt.getEntity().getLocation().getBlockZ());
                Point p2 = new Point(p.getLocation().getBlockX(), p.getLocation().getBlockZ());
                if (p1.distance(p2) <= 1) {
                    found = true;
                    if (throwcooldown.contains(p.getName())) {
                        if (evt.getEntity().getType() != EntityType.THROWN_EXP_BOTTLE) {
                            evt.setCancelled(true);
                        }
                    } else {
                        throwcooldown.add(p.getName());
                        Bukkit.getServer().getScheduler().runTaskLater(plugin, () -> throwcooldown.remove(p.getName()), 6L);
                    }
                }
            }
            if (!found) {
                boolean done = false;
                for (Location l : throwcooldownlocations) {
                    Point p1 = new Point(evt.getEntity().getLocation().getBlockX(), evt.getEntity().getLocation().getBlockZ());
                    Point p2 = new Point(l.getBlockX(), l.getBlockZ());
                    // We check if the entity is anywhere near our last
                    if (p1.distance(p2) <= 100) {
                        done = true;
                        evt.setCancelled(true);
                    }
                }
                if (!done) {
                    Location location = evt.getEntity().getLocation();
                    throwcooldownlocations.add(location);
                    Bukkit.getServer().getScheduler().runTaskLater(plugin, () -> throwcooldownlocations.remove(location), 20L);
                }
            }
        }
    }
}
