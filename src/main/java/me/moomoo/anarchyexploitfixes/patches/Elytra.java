package me.moomoo.anarchyexploitfixes.patches;

import lombok.RequiredArgsConstructor;
import me.moomoo.anarchyexploitfixes.Main;
import org.bukkit.*;
import org.bukkit.configuration.file.FileConfiguration;
import org.bukkit.entity.Entity;
import org.bukkit.entity.EntityType;
import org.bukkit.entity.Player;
import org.bukkit.event.EventHandler;
import org.bukkit.event.Listener;
import org.bukkit.event.entity.EntityToggleGlideEvent;
import org.bukkit.event.player.PlayerMoveEvent;
import org.bukkit.event.world.ChunkLoadEvent;
import org.bukkit.inventory.ItemStack;
import org.bukkit.inventory.PlayerInventory;

import java.awt.*;
import java.util.HashMap;
import java.util.Map;
import java.util.UUID;

@RequiredArgsConstructor
public class Elytra implements Listener {
    private final Main plugin;
    private final Map<UUID, Integer> levels = new HashMap<>();

    @EventHandler
    private void onMove(PlayerMoveEvent evt) {
        FileConfiguration config = plugin.getConfig();

        if (config.getBoolean("DisableAllElytras")) {
            Player player = evt.getPlayer();
            PlayerInventory i = player.getInventory();
            Location l = i.getLocation();
            if (i.getChestplate() != null && i.getChestplate().getType().equals(Material.ELYTRA)) {
                ItemStack elytra = i.getChestplate();
                i.setChestplate(null);
                l.getWorld().dropItemNaturally(l, elytra);
            }
        }

        if (config.getBoolean("PreventGoingBelowBedrockFloor")) {
            if (evt.getPlayer().getLocation().getY() < getMinimumHeight()) {
                if (!evt.getPlayer().getWorld().getEnvironment().equals(World.Environment.THE_END)) {
                    evt.getPlayer().getWorld().getBlockAt(evt.getPlayer().getLocation().getBlockX(), getMinimumHeight(), evt.getPlayer().getLocation().getBlockZ()).setType(Material.BEDROCK);
                    evt.setTo(evt.getFrom().add(0, 2, 0));
                }
            }
        }
    }

    @EventHandler
    public void onPlayerMove(PlayerMoveEvent evt) {
        FileConfiguration config = plugin.getConfig();

        if (evt.getPlayer().isGliding()) {
            Location from = evt.getFrom();
            Location to = evt.getTo();
            double distX = to.getX() - from.getX();
            double distZ = to.getZ() - from.getZ();
            double finalValue = Math.hypot(distX, distZ);
            double tps = Bukkit.getServer().getTPS()[0];
            if (tps < config.getDouble("Elytra")) {
                Player player = evt.getPlayer();
                PlayerInventory i = player.getInventory();
                Location l = i.getLocation();
                if (evt.getPlayer().getLocale().startsWith("es")) {
                    evt.getPlayer().sendActionBar(ChatColor.DARK_RED + "Los Elytras están actualmente deshabilitados porque el tps es mas bajo que " + config.getInt("Elytra"));
                } else {
                    evt.getPlayer().sendActionBar(ChatColor.DARK_RED + "Elytras are currently disabled because the tps is lower than " + config.getInt("Elytra"));
                }
                evt.setCancelled(true);
                if (config.getBoolean("RemoveElytra")) {
                    evt.getPlayer().setGliding(false);
                    if (i.getChestplate() != null && i.getChestplate().getType().equals(Material.ELYTRA)) {
                        ItemStack elytra = i.getChestplate();
                        i.setChestplate(null);
                        l.getWorld().dropItemNaturally(l, elytra);
                    }
                }
            } else {
                if (plugin.playersInNewChunks.contains(evt.getPlayer().getName())) {
                    double max_speed;
                    if (tps > plugin.getConfig().getDouble("ElytraBurstNewChunkTPS") && plugin.getConfig().getBoolean("EnableBursting") && (plugin.getConfig().getDouble("ElytraBurstNewChunkSpeed") > plugin.getConfig().getDouble("ElytraNewChunkSpeed"))) {
                        max_speed = plugin.getConfig().getDouble("ElytraBurstNewChunkSpeed");
                    } else {
                        max_speed = plugin.getConfig().getDouble("ElytraNewChunkSpeed");
                    }

                    boolean atSpawn = false;
                    if (plugin.getConfig().getBoolean("ElytraAtSpawn.Enabled")) {
                        atSpawn = isAtSpawnRadius(evt.getPlayer().getLocation());
                        if (atSpawn) {
                            max_speed = plugin.getConfig().getDouble("ElytraAtSpawn.SpeedNewChunks");
                        }
                    }

                    if (finalValue > (max_speed + 0.02) && !evt.getPlayer().isOp()) {
                        evt.setCancelled(true);
                        if (atSpawn) {
                            if (evt.getPlayer().getLocale().startsWith("es")) {
                                evt.getPlayer().sendActionBar(ChatColor.RED + "Baja la configuración de tu élitro, la velocidad está restringida en nuevos spawn chunks.");
                            } else {
                                evt.getPlayer().sendActionBar(ChatColor.RED + "Turn down your elytra settings, speed is restricted in new spawn chunks.");
                            }
                        } else {
                            if (evt.getPlayer().getLocale().startsWith("es")) {
                                evt.getPlayer().sendActionBar(ChatColor.RED + "Baja la configuración de tu élitro, la velocidad está restringida en nuevos chunks.");
                            } else {
                                evt.getPlayer().sendActionBar(ChatColor.RED + "Turn down your elytra settings, speed is restricted in new chunks.");
                            }
                        }

                        evt.getPlayer().playSound(evt.getPlayer().getLocation(), Sound.ENTITY_EXPERIENCE_ORB_PICKUP, 1.0F, 1.0F);
                    } else {
                        if (config.getBoolean("ElytraActionBar")) {
                            if (evt.getPlayer().getLocale().startsWith("es")) {
                                evt.getPlayer().sendActionBar(ChatColor.GRAY + "Estás volando en" + ChatColor.DARK_RED + " NUEVO" + ChatColor.GRAY + " chunks. Velocidad: " + (String.format("%.2f", Math.min((double) Math.round(finalValue * 100.0D) / 100.0D, 20.0D)) + ChatColor.DARK_GRAY + " / " + ChatColor.GRAY + max_speed));
                            } else {
                                evt.getPlayer().sendActionBar(ChatColor.GRAY + "You are flying in" + ChatColor.DARK_RED + " NEW" + ChatColor.GRAY + " chunks. Speed: " + (String.format("%.2f", Math.min((double) Math.round(finalValue * 100.0D) / 100.0D, 20.0D)) + ChatColor.DARK_GRAY + " / " + ChatColor.GRAY + max_speed));
                            }
                        }
                    }
                } else {
                    double max_speed;
                    if (tps > plugin.getConfig().getDouble("ElytraBurstOldChunkTPS") && plugin.getConfig().getBoolean("EnableBursting") && (plugin.getConfig().getDouble("ElytraBurstOldChunkSpeed") > plugin.getConfig().getDouble("ElytraOldChunkSpeed"))) {
                        max_speed = plugin.getConfig().getDouble("ElytraBurstOldChunkSpeed");
                    } else {
                        max_speed = plugin.getConfig().getDouble("ElytraOldChunkSpeed");
                    }

                    boolean atSpawn = false;
                    if (plugin.getConfig().getConfigurationSection("ElytraAtSpawn").getBoolean("Enabled")) {
                        atSpawn = isAtSpawnRadius(evt.getPlayer().getLocation());
                        if (atSpawn) {
                            max_speed = plugin.getConfig().getDouble("ElytraAtSpawn.SpeedOldChunks");
                        }
                    }

                    if (finalValue > (max_speed + 0.02) && !evt.getPlayer().isOp()) {
                        evt.setCancelled(true);
                        if (atSpawn) {
                            if (evt.getPlayer().getLocale().startsWith("es")) {
                                evt.getPlayer().sendActionBar(ChatColor.RED + "Baja la configuración de tu élitro, la velocidad está restringida en spawn chunks.");
                            } else {
                                evt.getPlayer().sendActionBar(ChatColor.RED + "Turn down your elytra settings, speed is restricted in spawn chunks.");
                            }
                        } else {
                            if (evt.getPlayer().getLocale().startsWith("es")) {
                                evt.getPlayer().sendActionBar(ChatColor.RED + "Baja la configuración de tu elytra, vas demasiado rápido.");
                            } else {
                                evt.getPlayer().sendActionBar(ChatColor.RED + "Turn down your elytra settings, you are going too fast.");
                            }
                        }
                        evt.getPlayer().playSound(evt.getPlayer().getLocation(), Sound.ENTITY_EXPERIENCE_ORB_PICKUP, 1.0F, 1.0F);
                    } else {
                        if (config.getBoolean("ElytraActionBar")) {
                            if (evt.getPlayer().getLocale().startsWith("es")) {
                                evt.getPlayer().sendActionBar(ChatColor.GRAY + "Estás volando en" + ChatColor.GREEN + " ANTIGUO" + ChatColor.GRAY + " chunks. Velocidad: " + (String.format("%.2f", Math.min((double) Math.round(finalValue * 100.0D) / 100.0D, 20.0D)) + ChatColor.DARK_GRAY + " / " + ChatColor.GRAY + max_speed));
                            } else {
                                evt.getPlayer().sendActionBar(ChatColor.GRAY + "You are flying in" + ChatColor.GREEN + " OLD" + ChatColor.GRAY + " chunks. Speed: " + (String.format("%.2f", Math.min((double) Math.round(finalValue * 100.0D) / 100.0D, 20.0D)) + ChatColor.DARK_GRAY + " / " + ChatColor.GRAY + max_speed));
                            }
                        }
                    }
                }
            }
        }
    }

    @EventHandler
    public void onChunkLoad(ChunkLoadEvent evt) {
        FileConfiguration config = plugin.getConfig();

        if (evt.isNewChunk()) {
            for (Player p : Bukkit.getOnlinePlayers()) {
                Point p1 = new Point(evt.getChunk().getX(), evt.getChunk().getZ());
                Point p2 = new Point(p.getLocation().getChunk().getX(), p.getLocation().getChunk().getZ());

                if (p1.distance(p2) < 100) {
                    plugin.playersInNewChunks.add(p.getName());
                    if (config.getBoolean("ChunksCommand")) {
                        plugin.newChunks.merge(p.getUniqueId(), 1, Integer::sum);
                        Bukkit.getScheduler().runTaskLater(plugin, () -> plugin.newChunks.merge(p.getUniqueId(), -1, Integer::sum), 20L);
                    }
                }
            }
        } else {
            for (Player p : Bukkit.getOnlinePlayers()) {
                Point p1 = new Point(evt.getChunk().getX(), evt.getChunk().getZ());
                Point p2 = new Point(p.getLocation().getChunk().getX(), p.getLocation().getChunk().getZ());

                if (p1.distance(p2) < 100) {
                    plugin.playersInNewChunks.remove(p.getName());
                    if (config.getBoolean("ChunksCommand")) {
                        plugin.oldChunks.merge(p.getUniqueId(), 1, Integer::sum);
                        Bukkit.getScheduler().runTaskLater(plugin, () -> plugin.oldChunks.merge(p.getUniqueId(), -1, Integer::sum), 20L);
                    }
                }
            }
        }

        if (config.getBoolean("RemoveSkullsOnChunkLoad")) {
            for (Entity e : evt.getChunk().getEntities()) {
                if (e.getType() == EntityType.WITHER_SKULL) {
                    e.remove();
                }
            }
        }
    }

    @EventHandler
    public void onOpen(EntityToggleGlideEvent evt) {
        if (plugin.getConfig().getBoolean("PatchPacketElytraFly")) {
            PlayerInventory i = ((Player) evt.getEntity()).getInventory();

            if (evt.getEntity() instanceof Player) {
                Player e = (Player) evt.getEntity();
                Integer level = levels.get(e.getUniqueId());
                if (level != null) {
                    if (level > plugin.getConfig().getInt("MaxElytraOpensPer10Seconds")) {
                        if (i.getChestplate() != null && i.getChestplate().getType().equals(Material.ELYTRA)) {
                            ItemStack elytra = i.getChestplate();
                            i.setChestplate(null);
                            evt.getEntity().getWorld().dropItemNaturally(i.getLocation(), elytra);
                        }
                    } else {
                        levels.merge(e.getUniqueId(), 1, Integer::sum);
                        Bukkit.getServer().getScheduler().runTaskLater(plugin, () -> levels.put(e.getUniqueId(), levels.get(e.getUniqueId()) - 1), 200L);
                    }
                } else {
                    levels.put(e.getUniqueId(), 1);
                    Bukkit.getServer().getScheduler().runTaskLater(plugin, () -> levels.put(e.getUniqueId(), levels.get(e.getUniqueId()) - 1), 200L);
                }
            }
        }
    }

    private Integer getMinimumHeight() {
        if (plugin.getServer().getWorlds().get(0).getMaxHeight() <= 256) {
            return 0;
        } else {
            return -64;
        }
    }

    private boolean isAtSpawnRadius(Location loc) {
        Point p1 = new Point((int) loc.getX(), (int) loc.getZ());
        Point p2 = new Point(0, 0);
        return p1.distance(p2) < plugin.getConfig().getInt("ElytraAtSpawn.Radius");
    }
}
