package me.moomoo.anarchyexploitfixes.patches;

import me.moomoo.anarchyexploitfixes.Main;
import org.bukkit.Material;
import org.bukkit.configuration.file.FileConfiguration;
import org.bukkit.entity.ChestedHorse;
import org.bukkit.entity.Entity;
import org.bukkit.event.EventHandler;
import org.bukkit.event.Listener;
import org.bukkit.event.entity.EntityPortalEvent;
import org.bukkit.event.player.PlayerInteractAtEntityEvent;
import org.bukkit.scheduler.BukkitRunnable;

public class DupeFixes implements Listener {
    private final Main plugin;

    public DupeFixes(Main plugin) {
        this.plugin = plugin;
    }

    @EventHandler
    private void onEntityPortalEvent(EntityPortalEvent evt) {
        FileConfiguration config = plugin.getConfig();

        if (config.getBoolean("PreventDonkeysFromGoingThroughPortals")) {
            Entity entity = evt.getEntity();
            if (config.getBoolean("DEBUG")) {
                plugin.getLogger().info("EntityPortalEvent  " + entity);
            }
            if (entity instanceof ChestedHorse) {
                if (((ChestedHorse) entity).isCarryingChest()) {
                    evt.setCancelled(true);
                    if (!config.getBoolean("NoConsoleOutput")) {
                        plugin.getLogger().info("Prevented a " + entity.toString() + " from going through portal");
                    }
                }
            }
        }
    }

    @EventHandler
    private void onEntityInteract(PlayerInteractAtEntityEvent evt) {
        FileConfiguration config = plugin.getConfig();

        if (config.getBoolean("DisableChestsOnDonkeys")) {
            if (evt.getRightClicked() instanceof ChestedHorse) {
                evt.setCancelled(true);
                (new BukkitRunnable() {
                    public void run() {
                        if (evt.getPlayer().getInventory().getItemInMainHand().getType() == Material.CHEST) {
                            ((ChestedHorse) evt.getRightClicked()).setCarryingChest(false);
                        }
                        ((ChestedHorse) evt.getRightClicked()).setCarryingChest(false);
                    }
                }).runTaskLater(plugin, 2L);
            }
        }
    }
}
