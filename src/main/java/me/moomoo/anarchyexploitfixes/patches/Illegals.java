package me.moomoo.anarchyexploitfixes.patches;

import lombok.RequiredArgsConstructor;
import me.moomoo.anarchyexploitfixes.Main;
import me.moomoo.anarchyexploitfixes.misc.ItemUtil;
import org.bukkit.Chunk;
import org.bukkit.Material;
import org.bukkit.SkullType;
import org.bukkit.World;
import org.bukkit.block.Block;
import org.bukkit.block.Container;
import org.bukkit.block.ShulkerBox;
import org.bukkit.block.Skull;
import org.bukkit.configuration.file.FileConfiguration;
import org.bukkit.enchantments.Enchantment;
import org.bukkit.event.EventHandler;
import org.bukkit.event.Listener;
import org.bukkit.event.block.BlockPlaceEvent;
import org.bukkit.event.inventory.*;
import org.bukkit.event.player.PlayerDropItemEvent;
import org.bukkit.event.player.PlayerInteractEvent;
import org.bukkit.event.player.PlayerJoinEvent;
import org.bukkit.event.world.ChunkLoadEvent;
import org.bukkit.inventory.ItemStack;
import org.bukkit.inventory.meta.BlockStateMeta;
import org.bukkit.inventory.meta.ItemMeta;
import org.bukkit.inventory.meta.SkullMeta;
import org.bukkit.inventory.meta.SpawnEggMeta;
import org.bukkit.scheduler.BukkitRunnable;

import java.util.Map;

@RequiredArgsConstructor
public class Illegals implements Listener {
    private final Main plugin;

    @EventHandler
    private void onPlayerInteractEvent(PlayerInteractEvent evt) {
        FileConfiguration config = plugin.getConfig();

        if (config.getBoolean("RemoveIllegalBlocksOnInteract")) {
            if (evt.getClickedBlock() != null) {
                if (evt.getClickedBlock().getState() instanceof Container) {
                    ((Container) evt.getClickedBlock().getState()).getInventory().forEach(this::revert);

                    config.getList("BANNED_BLOCKS").forEach(b -> ((Container) evt.getClickedBlock().getState()).getInventory().remove(Material.getMaterial((String) b)));
                }
            }
        }
    }

    @EventHandler
    private void onPlayerJoinEvent(PlayerJoinEvent evt) {
        FileConfiguration config = plugin.getConfig();

        if (config.getBoolean("RemoveIllegalBlocksOnJoin"))
            config.getStringList("BANNED_BLOCKS").forEach(b -> evt.getPlayer().getInventory().remove(Material.getMaterial(b)));

        evt.getPlayer().getInventory().forEach(this::revert);
    }

    @EventHandler
    private void onInventoryOpenEvent(InventoryOpenEvent evt) {
        FileConfiguration config = plugin.getConfig();

        if (config.getBoolean("RemoveIllegalBlocksOnInventoryOpen"))
            config.getStringList("BANNED_BLOCKS").forEach(b -> evt.getPlayer().getInventory().remove(Material.getMaterial(b)));

        evt.getPlayer().getInventory().forEach(this::revert);
    }

    @EventHandler
    private void onBlockDropItemEvent(PlayerDropItemEvent evt) {
        FileConfiguration config = plugin.getConfig();

        if (config.getBoolean("RemoveIllegalBlocksOnDrop"))
            revert(evt.getItemDrop().getItemStack());

        evt.getPlayer().getInventory().forEach(this::revert);
    }

    @EventHandler
    private void onChunkLoadEvent(ChunkLoadEvent evt) {
        if (!plugin.getConfig().getBoolean("RemoveALLIllegalBlocksOnCHUNKLOAD"))
            return;

        new Thread(() -> {
            Chunk c = evt.getChunk();

            if (!evt.isNewChunk()) {
                int cx = c.getX() << 4;
                int cz = c.getZ() << 4;

                for (int x = cx; x < cx + 16; x++) {
                    for (int z = cz; z < cz + 16; z++) {
                        for (int y = 0; y < 255; y++) {
                            if (!c.getWorld().getEnvironment().equals(World.Environment.THE_END)) {
                                if ((plugin.getConfig().getStringList("BANNED_BLOCKS").contains(c.getBlock(x, y, z).getType().toString()))) {
                                    if (y > 5) {
                                        if (evt.getChunk().getWorld().getEnvironment() == World.Environment.NETHER) {
                                            if (y < 123) {
                                                setToAir(c.getBlock(x, y, z));
                                            }
                                        }

                                        if (evt.getChunk().getWorld().getEnvironment() == World.Environment.NORMAL) {
                                            setToAir(c.getBlock(x, y, z));
                                        }
                                    }
                                }
                            }

                            if (plugin.getConfig().getBoolean("RemoveIllegalHeadsOnChunkLoad")) {
                                if (c.getBlock(x, y, z).getType() == Material.SKULL) {
                                    Skull skull = (Skull) c.getBlock(x, y, z).getState();

                                    if (skull.hasOwner() || skull.getSkullType() == SkullType.PLAYER) {
                                        setToAir(c.getBlock(x, y, z));
                                    }
                                }
                            }
                        }
                    }
                }
            }
        }).start();
    }

    @EventHandler
    private void onInventoryInteractEvent(InventoryInteractEvent evt) {
        FileConfiguration config = plugin.getConfig();

        if (config.getBoolean("RemoveIllegalBlocksOnInteract")) {
            config.getStringList("BANNED_BLOCKS").forEach(b -> {
                if (evt.getInventory().contains(Material.getMaterial(b))) {
                    evt.getInventory().remove(Material.getMaterial(b));
                    evt.setCancelled(true);
                }
            });
        }

        evt.getInventory().forEach(this::revert);
    }

    @EventHandler
    private void onInventoryClick(InventoryClickEvent evt) {
        FileConfiguration config = plugin.getConfig();

        if (config.getBoolean("RemoveIllegalBlocksOnClick"))
            revert(evt.getCurrentItem());

        evt.getWhoClicked().getInventory().forEach(this::revert);
    }

    @EventHandler
    private void onInventoryPickup(InventoryPickupItemEvent evt) {
        FileConfiguration config = plugin.getConfig();

        if (config.getBoolean("RemoveIllegalBlocksOnPickup")) {
            String item = evt.getItem().getType().toString();
            if (config.getStringList("BANNED_BLOCKS").contains(item)) {
                evt.getItem().remove();
            }
        }

        evt.getInventory().forEach(this::revert);
    }

    @EventHandler
    private void onInventoryMove(InventoryMoveItemEvent evt) {
        FileConfiguration config = plugin.getConfig();

        if (config.getBoolean("RemoveIllegalBlocksOnMove")) {
            revert(evt.getItem());

            evt.getSource().forEach(this::revert);
            evt.getDestination().forEach(this::revert);
        }
    }

    @EventHandler
    private void onBlockPlace(BlockPlaceEvent evt) {
        FileConfiguration config = plugin.getConfig();

        if (config.getBoolean("PreventPlacingIllegalBlocks")) {
            String block = evt.getBlockPlaced().getType().toString();

            if (config.getStringList("BANNED_BLOCKS").contains(block)) {
                if (config.getBoolean("RemoveIllegalBlockOnPlace")) {
                    config.getStringList("BANNED_BLOCKS").forEach(b -> {
                        if (evt.getPlayer().getInventory().contains(Material.getMaterial(b))) {
                            evt.getPlayer().getInventory().remove(Material.getMaterial(b));
                            evt.setCancelled(true);
                        }
                    });
                }

                evt.setCancelled(true);
            }

            evt.getPlayer().getInventory().forEach(this::revert);
        }
    }

    private void setToAir(final Block block) {
        new BukkitRunnable() {
            public void run() {
                if (!block.getType().equals(Material.AIR))
                    block.setType(Material.AIR);
            }
        }.runTask(plugin);
    }

    private void revert(ItemStack item) {
        if (item != null) {
            if (plugin.getConfig().getBoolean("LookInShulkers") && ItemUtil.isShulker(item)) {
                BlockStateMeta meta = (BlockStateMeta) item.getItemMeta();
                ShulkerBox box = (ShulkerBox) meta.getBlockState();

                box.getInventory().forEach(this::revert);

                box.update();
                meta.setBlockState(box);
                item.setItemMeta(meta);
            }

            if (plugin.getConfig().getBoolean("RevertStackedItems")) {
                if (plugin.getConfig().getBoolean("OnlyRevertStacksForCertainItems")) {
                    for (String s : plugin.getConfig().getStringList("RevertStackedItemsList")) {
                        if (item.getType().name().equals(s) && item.getAmount() > item.getMaxStackSize()) {
                            item.setAmount(item.getMaxStackSize());
                        }
                    }
                } else {
                    if (item.getAmount() > item.getMaxStackSize()) {
                        item.setAmount(item.getMaxStackSize());
                    }
                }
            }

            if (plugin.getConfig().getBoolean("RevertEnchantments"))
                revertEnchantments(item);

            if (plugin.getConfig().getBoolean("RemoveIllegalHeads") && item.getType().equals(Material.SKULL_ITEM)) {
                SkullMeta sm = (SkullMeta) item.getItemMeta();

                if (sm.hasOwner() || item.getData().toString().equals("SKULL_ITEM(3)")) {
                    item.subtract(item.getAmount());
                }
            }

            if (plugin.getConfig().getBoolean("RemoveSpawnEggs") && item.getItemMeta() instanceof SpawnEggMeta)
                item.subtract(item.getAmount());

            if (plugin.getConfig().getStringList("BANNED_BLOCKS").contains(item.getType().name()))
                item.subtract(item.getAmount());
        }
    }

    private void revertEnchantments(ItemStack c) {
        ItemMeta meta = c.getItemMeta();

        if (meta != null && meta.getEnchants() != null) {
            for (Map.Entry<Enchantment, Integer> e : meta.getEnchants().entrySet()) {
                if (e != null && e.getValue() != null && e.getKey() != null) {
                    if (plugin.getConfig().getBoolean("RevertSpecificEnchantments")) {
                        for (String s : plugin.getConfig().getStringList("SpecificEnchantments")) {
                            if (e.getValue() > e.getKey().getMaxLevel() && e.getKey().getName().contains(s)) {
                                c.setItemMeta(Main.replaceEnchantment(meta, e.getKey(), e.getKey().getMaxLevel()));
                            }
                        }
                    } else {
                        if (e.getValue() > e.getKey().getMaxLevel()) {
                            c.setItemMeta(Main.replaceEnchantment(meta, e.getKey(), e.getKey().getMaxLevel()));
                        }
                    }
                }
            }
        }
    }
}
