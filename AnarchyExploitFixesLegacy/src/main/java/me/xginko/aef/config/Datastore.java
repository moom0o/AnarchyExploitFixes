package me.xginko.aef.config;

import com.zaxxer.hikari.HikariConfig;
import com.zaxxer.hikari.HikariDataSource;
import me.xginko.aef.AnarchyExploitFixes;
import me.xginko.aef.utils.models.Disableable;

import javax.sql.DataSource;
import java.sql.Connection;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.sql.Statement;
import java.util.UUID;
import java.util.concurrent.CompletableFuture;

public class Datastore implements Disableable {

    private final DataSource dataSource;
    private final String loadPlayer, savePlayerConMsgSetting;

    public Datastore() {
        HikariConfig config = new HikariConfig();
        AnarchyExploitFixes plugin = AnarchyExploitFixes.getInstance();
        config.setJdbcUrl("jdbc:sqlite:" + plugin.getDataFolder().toPath() + "/data.db");
        config.setMaximumPoolSize(plugin.getServer().getMaxPlayers());
        this.dataSource = new HikariDataSource(config);
        createTables();
        this.loadPlayer = "SELECT * FROM `players` WHERE player_uuid = ?;";
        this.savePlayerConMsgSetting = "INSERT INTO `players` (player_uuid, show_connect_msgs) VALUES (?, ?) ON CONFLICT(player_uuid) DO UPDATE SET show_connect_msgs = ?;";
    }

    @Override
    public void disable() {
        try {
            dataSource.getConnection().close();
        } catch (SQLException ignored) {
        }
    }

    private void createTables() {
        try (Statement statement = dataSource.getConnection().createStatement()) {
            statement.execute("CREATE TABLE IF NOT EXISTS `players` (`player_uuid` varchar(36) NOT NULL PRIMARY KEY, `show_connect_msgs` boolean);");
        } catch (SQLException e) {
            AnarchyExploitFixes.prefixedLogger().trace("Error creating database tables!", e);
        }
    }

    public CompletableFuture<Boolean> getJoinLeaveEnabled(UUID uuid) {
        return CompletableFuture.supplyAsync(() -> {
            try (Connection connection = dataSource.getConnection(); PreparedStatement statement = connection.prepareStatement(loadPlayer)) {
                statement.setString(1, uuid.toString());
                ResultSet result = statement.executeQuery();
                if (result.next()) {
                    return result.getBoolean("show_connect_msgs");
                } else {
                    return AnarchyExploitFixes.config().connectionMsgsAreOnByDefault;
                }
            } catch (SQLException e) {
                AnarchyExploitFixes.prefixedLogger().error("Error getting connection message enable state from player!", e);
                return AnarchyExploitFixes.config().connectionMsgsAreOnByDefault;
            }
        });
    }

    public CompletableFuture<Void> setJoinLeaveEnabled(UUID uuid, boolean enable) {
        return CompletableFuture.runAsync(() -> {
            try (Connection connection = dataSource.getConnection(); PreparedStatement statement = connection.prepareStatement(savePlayerConMsgSetting)) {
                statement.setString(1, uuid.toString());
                statement.setBoolean(2, enable);
                statement.setBoolean(3, enable);
                statement.executeUpdate();
            } catch (SQLException e) {
                AnarchyExploitFixes.prefixedLogger().error("Error setting connection message enable state for player!", e);
            }
        });
    }
}
