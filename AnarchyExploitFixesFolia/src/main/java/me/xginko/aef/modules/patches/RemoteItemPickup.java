package me.xginko.aef.modules.patches;

import me.xginko.aef.AnarchyExploitFixes;
import me.xginko.aef.modules.AEFModule;
import me.xginko.aef.utils.EntityUtil;
import org.bukkit.event.EventHandler;
import org.bukkit.event.EventPriority;
import org.bukkit.event.HandlerList;
import org.bukkit.event.Listener;
import org.bukkit.event.player.PlayerAttemptPickupItemEvent;

public class RemoteItemPickup extends AEFModule implements Listener {

    private final double maxWidthX, maxHeight, maxWidthZ;
    private final boolean kickPlayer, log;

    public RemoteItemPickup() {
        super("patches.remote-item-pickup-exploit", false, """
                EXPERIMENTAL!
                Attempts to patch an exploit where players are able to expand their own
                hitbox, leading to them being able to pick up items at remote locations.
                NOTE: This isn't entirely verified yet. Any feedback is appreciated.""");
        this.log = config.getBoolean(configPath + ".log", true);
        this.maxHeight = config.getDouble(configPath + ".max-height", 4.0);
        this.maxWidthX = config.getDouble(configPath + ".max-width-X", 4.0);
        this.maxWidthZ = config.getDouble(configPath + ".max-width-Z", 4.0);
        this.kickPlayer = config.getBoolean(configPath + ".kick-player", true,
                "Kicks player if their hitbox is detected as too large.");
    }

    @Override
    public void enable() {
        plugin.getServer().getPluginManager().registerEvents(this, plugin);
    }

    @Override
    public void disable() {
        HandlerList.unregisterAll(this);
    }

    @EventHandler(priority = EventPriority.HIGHEST, ignoreCancelled = true)
    private void on(PlayerAttemptPickupItemEvent event) {
        if (EntityUtil.isBoundingBoxTooLarge(event.getPlayer(), maxWidthX, maxWidthZ, maxHeight)) {
            if (log) info("Player " + event.getPlayer().getName() + " tried to pickup an item but has a too large hitbox!");
            event.setCancelled(true);
            event.getPlayer().leaveVehicle();
            if (kickPlayer) {
                event.getPlayer().kick(AnarchyExploitFixes.translation(event.getPlayer()).misc_MaskedKickMessage);
            }
        }
    }
}
