package me.xginko.aef.modules.lagpreventions;

import com.cryptomorin.xseries.XMaterial;
import me.xginko.aef.modules.AEFModule;
import me.xginko.aef.utils.BlockUtil;
import org.bukkit.block.Block;
import org.bukkit.event.EventHandler;
import org.bukkit.event.EventPriority;
import org.bukkit.event.HandlerList;
import org.bukkit.event.Listener;
import org.bukkit.event.block.BlockPistonExtendEvent;

public class FloodingMachines extends AEFModule implements Listener {

    private final boolean remove;

    public FloodingMachines() {
        super("lag-preventions.prevent-flooding-machines", false, """
                Will prevent pistons from pushing waterlogged blocks.\s
                Stops players from using waterlogged blocks and piston flying\s
                machines to generate large walls of water that generate lag\s
                due to the fluid physics.""");
        this.remove = config.getBoolean(configPath + ".delete-waterlogged-blocks", true);
    }

    @Override
    public void enable() {
        plugin.getServer().getPluginManager().registerEvents(this, plugin);
    }

    @Override
    public void disable() {
        HandlerList.unregisterAll(this);
    }

    @EventHandler(priority = EventPriority.HIGHEST, ignoreCancelled = true)
    private void onPistonExtend(BlockPistonExtendEvent event) {
        for (Block block : event.getBlocks()) {
            if (BlockUtil.isWaterlogged(block.getState())) {
                if (remove) block.setType(XMaterial.AIR.get());
                event.setCancelled(true);
                return;
            }
        }
    }
}
