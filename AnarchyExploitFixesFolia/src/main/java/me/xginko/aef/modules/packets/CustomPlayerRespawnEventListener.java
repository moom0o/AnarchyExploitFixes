package me.xginko.aef.modules.packets;

import com.github.retrooper.packetevents.event.PacketListenerPriority;
import com.github.retrooper.packetevents.event.PacketReceiveEvent;
import com.github.retrooper.packetevents.protocol.packettype.PacketType;
import com.github.retrooper.packetevents.wrapper.play.client.WrapperPlayClientClientStatus;
import io.papermc.lib.PaperLib;
import me.xginko.aef.AnarchyExploitFixes;
import org.bukkit.Bukkit;
import org.bukkit.entity.Player;

import java.util.concurrent.TimeUnit;

import static com.github.retrooper.packetevents.wrapper.play.client.WrapperPlayClientClientStatus.Action.PERFORM_RESPAWN;

public class CustomPlayerRespawnEventListener extends PacketModule {

    public CustomPlayerRespawnEventListener() {
        super("", PacketListenerPriority.HIGHEST);
    }

    @Override
    public boolean shouldEnable() {
        return AnarchyExploitFixes.isServerFolia;
    }

    @Override
    public void onPacketReceive(PacketReceiveEvent event) {
        if (event.getPacketType() != PacketType.Play.Client.CLIENT_STATUS) return;
        WrapperPlayClientClientStatus packet = new WrapperPlayClientClientStatus(event);
        if (packet.getAction() == PERFORM_RESPAWN) {
            plugin.getServer().getAsyncScheduler().runDelayed(plugin, task -> {
                CustomPlayerRespawnEvent evt = new CustomPlayerRespawnEvent((Player) event.getPlayer());
                Bukkit.getServer().getPluginManager().callEvent(evt);
                if (evt.isCancelled()) {
                    event.setCancelled(true);
                }
            }, 1, TimeUnit.SECONDS);
        }
    }
}